<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>상세 정보</title>
<link rel="stylesheet" href="/css/detailStyle.css">
<link href="/css/mainStyle.css" rel="stylesheet">
</head>
<body>
  <th:block th:replace="/fragment::header"></th:block>
   
   <div id="out">
   <div id="detail">
    <header>
      <div class="navbar">
         <div class="navbar-left">
            <h1 th:text="${place['title']}">이름</h1>
         </div>
         <div class="navbar-right">
        <div class="heart-container" title="Like">
    <!-- 체크박스의 초기 상태는 isLiked 값에 따라 설정 -->
    <input type="checkbox" class="checkbox" id="Give-It-An-Id" th:checked="${isLiked == 1}" th:onclick="handleLike()">
    <div class="svg-container">
        <!-- 비어있는 하트 (isLiked가 0이거나 null인 경우) -->
        <svg th:if="${isLiked != 1}" viewBox="0 0 24 24" class="svg-outline" xmlns="http://www.w3.org/2000/svg">
            <path d="M17.5,1.917a6.4,6.4,0,0,0-5.5,3.3,6.4,6.4,0,0,0-5.5-3.3A6.8,6.8,0,0,0,0,8.967c0,4.547,4.786,9.513,8.8,12.88a4.974,4.974,0,0,0,6.4,0C19.214,18.48,24,13.514,24,8.967A6.8,6.8,0,0,0,17.5,1.917Zm-3.585,18.4a2.973,2.973,0,0,1-3.83,0C4.947,16.006,2,11.87,2,8.967a4.8,4.8,0,0,1,4.5-5.05A4.8,4.8,0,0,1,11,8.967a1,1,0,0,0,2,0,4.8,4.8,0,0,1,4.5-5.05A4.8,4.8,0,0,1,22,8.967C22,11.87,19.053,16.006,13.915,20.313Z">
            </path>
        </svg>
        <!-- 채워진 하트 (isLiked가 1인 경우) -->
        <svg th:if="${isLiked == 1}" viewBox="0 0 24 24" class="svg-filled" xmlns="http://www.w3.org/2000/svg">
            <path d="M17.5,1.917a6.4,6.4,0,0,0-5.5,3.3,6.4,6.4,0,0,0-5.5-3.3A6.8,6.8,0,0,0,0,8.967c0,4.547,4.786,9.513,8.8,12.88a4.974,4.974,0,0,0,6.4,0C19.214,18.48,24,13.514,24,8.967A6.8,6.8,0,0,0,17.5,1.917Z">
            </path>
        </svg>
    </div>
</div>
         </div>
      </div>
   </header>

   <section class="slider">
      <div class="mainimg">
         <img th:if="${place['firstimage'] != null and !place['firstimage'].isEmpty()}"
         th:src="${place.firstimage}" alt="Image" class="placefirstimage" />
        <!-- 이미지가 없을 때 -->
         <img th:if="${place['firstimage'] == null or place['firstimage'].isEmpty()}"
          th:src="@{/image/replace.png}" alt="Default Image"  class="placefirstimage"/>
      </div>
      <div class="table-container">
          <table>  
          <tbody th:if="@{${place['contenttypeid']} == 14}">
          <tr>
            <th>쉬는날</th>
            <td th:text="${detail['restculture']}"></td>
          </tr>
          <tr>
            <th>이용시간</th>    
             <td th:text="${detail['usetimeculture']}"></td>
          </tr>
          <tr>
            <th>이용요금</th>
            <td th:text="${detail['usefee']}"></td>
          </tr>
          <tr>
            <th>문의 및 안내</th>
            <td th:text="${detail['infocenterculture']}"></td>
          </tr>
          <tr>
            <th>주차시설</th>
            <td th:text="${detail['parkingculture']}"></td>
          </tr>
          <tr>
            <th>유모차 대여여부</th>
            <td th:text="${detail['chkbagcarriageculture']}"></td>
          </tr>
          </tbody>
          <tbody th:if="@{${place['contenttypeid']} == 12}">
          <tr>
            <th>문의 및 안내</th>
            <td th:text="${detail['info']}"></td>
          </tr>
          <tr>
            <th>체험가능연령</th>    
             <td th:text="${detail['expgname']}"></td>
          </tr>
          <tr>
            <th>쉬는날</th>
            <td th:text="${detail['restdate']}"></td>
          </tr>
          <tr>
            <th>이용시간</th>
            <td th:text="${detail['usetime']}"></td>
          </tr>
          <tr>
            <th>주차</th>
            <td th:text="${detail['parking']}"></td>
          </tr>
          <tr>
            <th>유모차 대여 여부</th>
            <td th:text="${detail['chkbagcarriage']}"></td>
          </tr>
          <tr>
            <th>애완동물 동반가능 여부</th>
            <td th:text="${detail['chkpet']}"></td>
          </tr>
          </tbody>
          <tbody th:if="@{${place['contenttypeid']} == 28}">
          <tr>
            <th>문의 및 안내</th>
            <td th:text="${detail['incentreleports']}"></td>
          </tr>
          <tr>
            <th>쉬는날</th>    
             <td th:text="${detail['restateleports']}"></td>
          </tr>
          <tr>
            <th>이용시간</th>
            <td th:text="${detail['usetimeleports']}"></td>
          </tr>
          <tr>
            <th>주차시설</th>
            <td th:text="${detail['parkingleports']}"></td>
          </tr>
          <tr>
            <th>parkingfeeleports</th>
            <td th:text="${detail['parkingfeeleports']}"></td>
          </tr>
          </tbody>
          <tbody th:if="@{${place['contenttypeid']} == 32}">
          <tr>
            <th>문의 및 안내</th>
            <td th:text="${detail['incentreleports']}"></td>
          </tr>
          <tr>
            <th>체크인</th>    
             <td th:text="${detail['chkintime']}"></td>
          </tr>
          <tr>
            <th>체크아웃</th>
            <td th:text="${detail['chkouttime']}"></td>
          </tr>
          <tr>
            <th>조리가능여부</th>
            <td th:text="${detail['cooking']}"></td>
          </tr>
          <tr>
            <th>roomtype</th>
            <td th:text="${detail['roomtype']}"></td>
          </tr>
          <tr>
            <th>주차 가능 여부</th>
            <td th:text="${detail['parkinglodging']}"></td>
          </tr>
          <tr>
            <th>예약안내 홈페이지</th>
            <td th:text="${detail['reservationurl']}"></td>
          </tr>
          </tbody>
          <tbody th:if="@{${place['contenttypeid']} == 39}">
          <tr>
            <th>문의 및 안내</th>
            <td th:text="${detail['infocenterfood']}"></td>
          </tr>
          <tr>
            <th>오픈시간</th>    
             <td th:text="${detail['opentimefood']}"></td>
          </tr>
          <tr>
            <th>대표메뉴</th>
            <td th:text="${detail['firstmenu']}"></td>
          </tr>
          <tr>
            <th>쉬는날</th>
            <td th:text="${detail['restdatefood']}"></td>
          </tr>
          </tbody>
         </table>
      </div>
   </section>
   
   <section class="features">
      <h2>개요</h2>
      <div th:text="${place['overview']}"></div>
   </section>
   

   <section class="reviews">
   
   <h2>후기 및 별점</h2>
      <div>
         <span>평균 별점: <strong id="average-rating">0</strong></span> / 5
      </div>

      <!-- 기존 리뷰들 출력 -->
      <div th:each="review : ${reviews}" class="review-item">
         <p>
            <strong th:text="${review.nick}"></strong>: <span class="rating"
               th:each="i : ${#numbers.sequence(1, review.rating)}">⭐</span> <span
               th:text="${review.contents}"></span> <em th:text="${review.w_date}"></em>
            <!-- 리뷰별 별점 값을 표시하는 숨겨진 span 추가 -->
            <span class="rating-value" th:text="${review.rating}"
               style="display: none;"></span>
         </p>
         
          <!-- 수정 및 삭제 버튼 (본인 또는 관리자만) -->
         <div
            th:if="${review.a_idx == session.user.accounts_idx or session.user.role == 'ADMIN'}">
            <button th:onclick="|fn_update('${review.drep_idx}')|"
               th:classid="editBtn_" type="button">수정</button>
            <form
               th:action="@{/member/review/delete/{id}(id=${review.drep_idx},contenttypeid=${detail['contenttypeid']},contentid=${detail['contentid']})}"
               method="post" style="display: inline;">
               <!-- p_idx를 히든 필드로 추가 -->
               <input type="hidden" name="p_idx" th:value="${review.p_idx}">
               <button type="submit">삭제</button>
            </form>
         </div>
         <!-- 수정 폼 (기본적으로 숨김) -->
         <div th:id="'editForm_' + ${review.drep_idx}" style="display: none">
            <form method="POST" th:action="@{/member/review/edit}">
               <div class="rating">
                  <label> <input type="radio" name="rating" value="1"
                     th:checked="${review.rating == 1}"> 1
                  </label> <label> <input type="radio" name="rating" value="2"
                     th:checked="${review.rating == 2}"> 2
                  </label> <label> <input type="radio" name="rating" value="3"
                     th:checked="${review.rating == 3}"> 3
                  </label> <label> <input type="radio" name="rating" value="4"
                     th:checked="${review.rating == 4}"> 4
                  </label> <label> <input type="radio" name="rating" value="5"
                     th:checked="${review.rating == 5}"> 5
                  </label>
               </div>
               <textarea name="contents" th:text="${review.contents}"></textarea>
               <button type="submit">수정 완료</button>
               <input name="drep_idx" type="hidden" th:value="${review.drep_idx}">
               <input name="p_idx" type="hidden" th:value="${review.p_idx}">
               <input name="contentid" type="hidden" th:value="${detail['contentid']}">
         <input name="contenttypeid" type="hidden" th:value="${detail['contenttypeid']}">
            </form>
         </div>
         
   </div>
   <form id="reviewForm" method="POST" th:action="@{/member/review}">
         <div class="rating">
            <label> <input type="radio" name="rating" value="1">1</label> 
            <label> <input type="radio" name="rating" value="2">2</label> 
            <label> <input type="radio" name="rating" value="3">3</label> 
            <label> <input type="radio" name="rating" value="4">4</label> 
            <label> <input type="radio" name="rating" value="5">5</label>
         </div>
         <textarea name="contents" placeholder="후기를 작성하세요"></textarea>
         <button type="submit">등록</button>
         <input name="a_idx" type="hidden" th:value="${session.user.accounts_idx}"> 
         <input name="p_idx" type="hidden" th:value="${detailpage.idx}">
         <input name="contentid" type="hidden" th:value="${detail['contentid']}">
         <input name="contenttypeid" type="hidden" th:value="${detail['contenttypeid']}">
      </form>
  
   </section>
    </div>
      <script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
    // 리뷰 항목들을 가져옴
    const reviews = document.querySelectorAll('.review-item');
    let totalRating = 0;
    let reviewCount = 0;

    reviews.forEach(function(review) {
        // 리뷰에서 직접 별점 값을 가져옴
        const rating = parseInt(review.querySelector('.rating-value').textContent);
        totalRating += rating;
        reviewCount += 1;
    });

    // 평균 별점 계산
    const averageRating = reviewCount > 0 ? (totalRating / reviewCount).toFixed(1) : '0';

    // 평균 별점을 HTML 요소에 표시
    document.getElementById('average-rating').textContent = averageRating;
});

    
    function fn_update(idx) {
        const formId = 'editForm_' + idx;
        document.querySelector('#' + formId).style.display = "block";
    }

function handleLike() {
    const checkbox = document.getElementById('Give-It-An-Id');
    const data = {
        a_idx: [[${session.user.accounts_idx}]],  
        title: "[[${detailpage.title}]]",
        addr1: "[[${detailpage.addr1}]]",
        firstimage: "[[${detailpage.firstimage}]]",
        mapx: [[${detailpage.mapx}]],
        mapy: [[${detailpage.mapy}]],
        p_idx: [[${detailpage.idx}]],
        contenttypeid: [[${detailpage.contenttypeid}]],
        contentid: [[${detailpage.contentid}]]
    };

    if (checkbox.checked) {
        fetch('/member/like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
                alert('좋아요 추가 완료!');
            } else {
                alert('좋아요 추가 실패');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    } else {
        fetch('/member/like', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
                alert('좋아요 삭제 완료!');
            } else {
                alert('좋아요 삭제 실패');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
}

  </script>
 <script th:if="${alertMessage != null}">
        alert("[[${alertMessage}]]");
    </script>
    
    
    </div>
    <th:block th:replace="/fragment::footer"></th:block>


</body>
</html>
